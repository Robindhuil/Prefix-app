generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             Int      @id @default(autoincrement())
  username       String   @unique
  email          String?  @unique
  name           String?
  hashedpassword String
  role           Role     @default(USER)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Dokumenty patriace pou≈æ√≠vateƒæovi
  documents Document[] @relation("UserDocuments")

  // Dokumenty, ktor√© nahral
  uploaded Document[] @relation("DocumentCreator")

  // üîπ Priradenia do pracovn√Ωch obdob√≠
  assignments UserAssignment[]
}

enum Role {
  ADMIN
  USER
}

model CompanyInfo {
  companyId             String   @id
  companyName           String
  companyIdNumber       String
  legalForm             String
  foundingDate          DateTime
  registeredOffice      String
  shareCapital          String
  representation        String
  representativeName    String
  representativeAddress String
  functionStartDate     DateTime
  contactEmail          String
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// ========================================
// DOKUMENTY (pre MEGA / GCS / S3)
// ========================================
model Document {
  id Int @id @default(autoincrement())

  // Vlastn√≠k
  userId Int
  user   User @relation("UserDocuments", fields: [userId], references: [id], onDelete: Cascade)

  // Kto nahral
  createdBy Int
  creator   User @relation("DocumentCreator", fields: [createdBy], references: [id])

  // S√∫bor
  fileName String
  gcsPath  String @unique // MEGA: "https://mega.nz/file/abc#key" alebo GCS: "documents/user-123/file.enc"
  mimeType String // "application/pdf"
  size     Int? // v bytoch

  // ≈†ifrovanie (voliteƒæn√© ‚Äì ak ≈°ifruje≈° TY)
  iv         String? // base64
  tag        String? // base64 (AES-GCM)
  keyVersion Int? // rot√°cia kƒæ√∫ƒçov

  // Integrita
  hash String? // SHA256 base64

  // Metad√°ta
  documentType DocumentType
  description  String?

  // Audity
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  deletedAt       DateTime? // soft delete
  assignmentLinks AssignmentDocument[]

  @@index([userId])
  @@index([createdBy])
  @@index([documentType])
  @@index([createdAt])
  @@index([gcsPath])
}

enum DocumentType {
  INVOICE
  ORDER
  CONTRACT
  OTHER
}

// ========================================
// PRACOVN√â OBDOBIA / PROJEKTY / KARTY
// ========================================
model WorkPeriod {
  id          Int      @id @default(autoincrement())
  title       String // napr. "Stavba A ‚Äì marec 2025"
  startDate   DateTime
  endDate     DateTime
  description String?

  // Po≈æiadavka ‚Äì koƒæko ƒæud√≠ a ak√Ωch profesi√≠ je treba
  requirements WorkRequirement[]

  // Priraden√≠ pracovn√≠ci
  assignments UserAssignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ========================================
// PO≈ΩIADAVKY NA PROFESIE V DANOM OBDOB√ç
// ========================================
model WorkRequirement {
  id           Int        @id @default(autoincrement())
  profession   Profession
  countNeeded  Int
  workPeriod   WorkPeriod @relation(fields: [workPeriodId], references: [id])
  workPeriodId Int
}

enum Profession {
  WELDER
  BRICKLAYER
  OTHER
}

// ========================================
// PRIRADENIE U≈Ω√çVATEƒΩA K OBDOBIU
// ========================================
model UserAssignment {
  id           Int @id @default(autoincrement())
  userId       Int
  workPeriodId Int

  // flexibiln√© obdobie
  fromDate DateTime
  toDate   DateTime

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  workPeriod WorkPeriod @relation(fields: [workPeriodId], references: [id], onDelete: Cascade)

  // Dokumenty ≈°pecifick√© pre dan√©ho u≈æ√≠vateƒæa v tomto obdob√≠
  documents AssignmentDocument[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([workPeriodId])
}

// ========================================
// DOKUMENTY NAVIAZAN√â NA ASSIGNMENT
// ========================================
model AssignmentDocument {
  id               Int @id @default(autoincrement())
  userAssignmentId Int
  documentId       Int

  userAssignment UserAssignment @relation(fields: [userAssignmentId], references: [id], onDelete: Cascade)
  document       Document       @relation(fields: [documentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}
